<!DOCTYPE html>
<html>
<meta charset="utf-8" />
<title>HaGUI</title>
<script src="https://www.google.com/jsapi" type="text/javascript"></script>
<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
<script language="javascript" type="text/javascript">
//var wsUri = "ws://192.168.100.40:8080/";
var wsUri = "ws://localhost:8080/";
var output;
var cmd = "";
var doCmd2 = false;
var doCmd3 = false;

google.load("visualization", "1", {packages:["corechart","table"]});

function init()
{
    output = document.getElementById("output");
    connect();
}

function connect()
{
    websocket = new WebSocket(wsUri);
    websocket.onopen = onOpen;
    websocket.onclose = onClose;
    websocket.onmessage = onMessage;
    websocket.onerror = onError;
}

function onOpen(evt)
{
    writeToScreen("CONNECTED");

    doCmd2 = true;
    doCmd3 = true;
    doSend('cmd1');
}

function onClose(evt)
{
    writeToScreen("DISCONNECTED");
}


function drawPie(ctrl, name, data)
{
    var resp = JSON.parse(data);
    var data = google.visualization.arrayToDataTable(resp);
    var options = { title: name,
		    legend: 'none'};
    var chart = new google.visualization.PieChart(document.getElementById(ctrl));
    chart.draw(data, options);
}

function drawLine(ctrl, name, data)
{
    var resp = JSON.parse(data);
    var resp2 = resp.map(function(line) {
	if (line[0] === "time")
	    return line;
	line[0] = new Date(line[0]);
	return line;
    });
    var data = google.visualization.arrayToDataTable(resp2);
    var options = { title: name,
                    curveType: 'none',
                    legend: { position: 'bottom' }
                  };

    var formatter = new google.visualization.DateFormat({pattern: 'd HH:mm'});
    formatter.format(data, 1);

    var chart = new google.visualization.LineChart(document.getElementById(ctrl));
    chart.draw(data, options);
}

function drawTable(ctrl, name, data)
{
    var resp = JSON.parse(data);
    var data = google.visualization.arrayToDataTable(resp);
    var options = { showRowNumber: true,
		            legend: 'none'};
    var table = new google.visualization.Table(document.getElementById(ctrl));
    table.draw(data, options);
}


function onMessage(evt)
{
    //writeToScreen('<span style="color: blue;">'+cmd+': ' + JSON.stringify(resp)+'</span>');
    switch (cmd) {
    case 'cmd1':
        drawLine("chart1", "Temperature", evt.data);
	if (doCmd2)
	    doSend("cmd2");
	break;

    case 'cmd2':
        drawLine("chart2", "Humidity", evt.data);
	if (doCmd3)
	    doSend("cmd3");
	break;

    case 'cmd3':
        drawTable("chart3", "None", evt.data);
	break;

    case 'cmd4':
        drawLine("chart4", "None", evt.data);
	break;

    case 'cmd5':
        drawTable("chart5", "None", evt.data);
	break;
	
    default:
        writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
        alert('Unknown command:' + cmd);
	break;
    }
}

function onError(evt)
{
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
}

function doSend(message)
{
    //writeToScreen("SENT: " + message);
    cmd = message;
    websocket.send(message);
}

function writeToScreen(message)
{
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
}

window.addEventListener("load", init, false);

//------------------------------------------------------------------------------

var haApp = angular.module('haApp', []);

haApp.config(function($routeProvider) {
    $routeProvider
    .when('/', {
	controller: 'HaController',
	templateUrl: 'Partials/home.html'
    })
    .when('/config', {
	controller: 'HaController',
	templateUrl: 'Partials/config.html'
    })
    .when('/status', {
	controller: 'HaController',
	templateUrl: 'Partials/status.html'
    })
    .otherwise({ redirecTo: '/' });
});


</script>
<body ng-app>
  <form action = "">
    <fieldset>
      <button type = "button"
              onclick = "connect()">
        connect
      </button>
      <button type = "button"
              onclick = "doSend('cmd1')">
        cmd1
      </button>
      <button type = "button"
              onclick = "doSend('cmd2')">
        cmd2
      </button>
      <button type = "button"
              onclick = "doSend('cmd3')">
        cmd3
      </button>
      <button type = "button"
              onclick = "doSend('cmd4')">
        cmd4
      </button>
      <button type = "button"
              onclick = "websocket.close()">
        disconnect
      </button>
    </fieldset>
  </form>

  <table>
    <tr>
      <td><div id="chart1" style="width: 500px; height: 300px;"></div></td>
      <td><div id="chart3" style="width: 500px; height: 300px;"></div></td>
    </tr>
    <tr>
      <td><div id="chart2" style="width: 500px; height: 300px;"></div></td>
      <td><div id="chart4" style="width: 500px; height: 300px;"></div></td>
    </tr>
  </table>
  <h4>Log</h4>
  <div id="output"></div>
</body>
</html>
