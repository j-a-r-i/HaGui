<!DOCTYPE html>
<head>
<meta charset="utf-8" />
<meta name="author" content="Jari Ojanen">
<title>HaGUI</title>
<script src="https://www.google.com/jsapi" type="text/javascript"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.7/angular-route.min.js"></script>
<script language="javascript" type="text/javascript">
var wsUri = "ws://192.168.100.40:8080/";
//var wsUri = "ws://localhost:8080/";
var output;
var cmd = "";
var stat = null;
var doCmd2 = false;
var doCmd3 = false;

const CMD_DATA1 ="cmd1";
const CMD_DATA2 ="cmd2";
const CMD_DATA3 ="cmd3";
const CMD_WEATHER = "cmd4";
const CMD_STATUS = "stat";
const CMD_CONTROL = "ctrl";
const CMD_CONTROL1 = "ctl1";
const CMD_CONTROL2 = "ctl2";
const CMD_CONTROL3 = "ctl3";
const CMD_LOGGING = "log1";

google.load("visualization", "1", {packages:["corechart","table"]});

function init()
{
    output = document.getElementById("output");
    connect();
}

function connect()
{
    websocket = new WebSocket(wsUri);
    websocket.onopen = onOpen;
    websocket.onclose = onClose;
    websocket.onmessage = onMessage;
    websocket.onerror = onError;
}

function onOpen(evt)
{
    //writeToScreen("CONNECTED");

    doCmd2 = true;
    doCmd3 = true;
    send(CMD_DATA1);
}

function onClose(evt)
{
    //writeToScreen("DISCONNECTED");
}


function drawPie(ctrl, name, msg)
{
    var resp = JSON.parse(msg);
    var data = google.visualization.arrayToDataTable(resp);
    var options = { title: name,
		    legend: 'none'};
    var chart = new google.visualization.PieChart(document.getElementById(ctrl));
    chart.draw(data, options);
}

function drawLine(ctrl, name, data, parse)
{
    var resp2;
    
    if (parse === true) {
        var resp = JSON.parse(data);
        resp2 = resp.map(function(line) {
            if (line[0] === "time")
                return line;
            line[0] = new Date(line[0]);
            return line;
        });
    }
    else {
        resp2 = data;
    }
    var vdata = google.visualization.arrayToDataTable(resp2);
    var options = { title: name,
                    curveType: 'none',
                    hAxis: { format: 'HH:mm' },
                    legend: { position: 'bottom' }
                  };

    var formatter = new google.visualization.DateFormat({pattern: 'HH:mm'});
    formatter.format(vdata, 1);

    var chart = new google.visualization.LineChart(document.getElementById(ctrl));
    chart.draw(vdata, options);
}

function drawTable(ctrl, name, msg)
{
    var resp = JSON.parse(msg);
    var data = google.visualization.arrayToDataTable(resp);
    var options = { showRowNumber: true,
		            legend: 'none'};
    var table = new google.visualization.Table(document.getElementById(ctrl));
    table.draw(data, options);
}


function onMessage(evt)
{
    //writeToScreen('<span style="color: blue;">'+cmd+': ' + JSON.stringify(resp)+'</span>');
    switch (cmd) {
    case CMD_DATA1:
       drawLine("chart1", "Temperature", evt.data, true);
	   if (doCmd2)
	        send(CMD_DATA2);
	   break;

    case CMD_DATA2:
        drawLine("chart2", "Humidity", evt.data, true);
        if (doCmd3)
            send(CMD_DATA3);
        break;

    case CMD_DATA3:
        drawTable("chart3", "None", evt.data, true);
    	break;

    case CMD_WEATHER:
        var arr = [["Time", "Temp"]];
        var data = JSON.parse(evt.data);
        data.forEach(function(i) {
           if (i != null) {
               arr.push([new Date(i.date), parseFloat(i.temp)]);
           } 
        });
        drawLine("chart4", "Forecast", arr, false);
    	break;

    case 'cmd5':
        drawTable("chart5", "None", evt.data, false);
    	break;
	
    case CMD_STATUS:
        alert(evt.data);
        break;
        
    case CMD_CONTROL:
        break;
    
    default:
        writeToScreen('<span style="color: blue;">RESPONSE: ' + evt.data+'</span>');
        alert('Unknown command:' + cmd + '\n' + evt.data);
    	break;
    }
}

function onError(evt)
{
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
}

function send(command)
{
/*    if (args === undefined) {
        args = [];
    }
    //writeToScreen("SENT: " + message);
    var msg = [command].concat(args);
*/    
    var msg = [command];
    cmd = command;
    websocket.send(JSON.stringify(msg));
}

function send2(command, args)
{
/*    if (args === undefined) {
        args = [];
    }
    //writeToScreen("SENT: " + message);
    var msg = [command].concat(args);
*/    
    var msg = [command].concat(args);
    cmd = command;
    websocket.send(JSON.stringify(msg));
}


function writeToScreen(message)
{
    var pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
}

window.addEventListener("load", init, false);

//------------------------------------------------------------------------------

var app = angular.module('haApp', ['ngRoute']);

app.config(function($routeProvider) {
    $routeProvider
        .when('/', {
	        controller: 'HaController',
	        templateUrl: 'partials/home.html'
        })
        .when('/home', {
	        controller: 'HaController',
	        templateUrl: 'partials/home.html'
        })
        .when('/config', {
	        controller: 'HaCtrlController',
	        templateUrl: 'partials/config.html'
        })
        .when('/status', {
	        controller: 'HaStatController',
	        templateUrl: 'partials/status.html'
        })
        .when('/actions', {
	        controller: 'ActController',
	        templateUrl: 'partials/actEditor.html'
        })
        .otherwise({ redirecTo: '/' });
});

app.controller('HaController', ['$scope', function ($scope) {
  console.log("HaController");
  $scope.commands = [CMD_DATA1,
                     CMD_DATA2,
                     CMD_DATA3];
}]);

function createDate(hour, min)
{
    var ret = new Date();
    
    ret.setHours(hour);
    ret.setMinutes(min);
    ret.setSeconds(0);
    ret.setMilliseconds(0);
    
    return ret;
}

app.controller('HaCtrlController', ['$scope', function ($scope) {
    $scope.car1Leave = createDate(7,35);    
    $scope.car2Leave = createDate(8,15);
    $scope.lightStart = createDate(16, 0);
    $scope.lightStop  = createDate(20, 30);
    
    $scope.submit1 = function() {
        var date = new Date($scope.car1Leave);

        send2(CMD_CONTROL1, [date.getHours(), date.getMinutes()]);
        console.log("CAR1 :" + $scope.car1Leave);
    };
    $scope.submit2 = function() {
        var date = new Date($scope.car2Leave);

        send2(CMD_CONTROL2, [date.getHours(), date.getMinutes()]);
        console.log("CAR2 :" + $scope.car2Leave);
    };
    $scope.submit3 = function() {
   };
}]);

app.controller('HaStatController', ['$scope', function ($scope) {
    $scope.data = ["<empty"];
    
    $scope.update = function() {
        stat = $scope;
        send(CMD_STATUS);  
    };
}]);

app.controller('ActController', ['$scope', function ($scope) {
    $scope.actions = [{name:"Car1",       url:"partials/actionCar.html"},
                      {name:"Car2",       url:"partials/actionCar.html"},
                      {name:"Interval",   url:"partials/actionInterval.html"},
                      {name:"Range",      url:"partials/actionRange.html"},
                      
    ];
    
    $scope.action = $scope.actions[0];
}]);


//------------------------------------------------------------------------------
</script>
<style media="screen" type="text/css">
body {
  padding-top: 0px;
  padding-bottom: 0px;
}
fieldset { 
  display: block;
  border: solid 1px grey;
  background-color: lightgrey;
  padding-top: 0.1em;
  padding-bottom: 0.1em;
  padding-left: 0.5em;
  padding-right: 0.5em;
  margin-left: 0px;
  margin-right: 0px;
}
.chartbox {
  display: inline-block;
  border: solid 1px grey;
  background-color: lightgrey;
  margin: 2px;
}

.slide-animate-container {
  position:relative;
  background:white;
  border:1px solid black;
  height:40px;
  overflow:hidden;
}
.slide-animate {
  padding:10px;
}
.slide-animate.ng-enter, .slide-animate.ng-leave {
  transition:all cubic-bezier(0.250, 0.460, 0.450, 0.940) 0.5s;
  position:absolute;
  top:0;
  left:0;
  right:0;
  bottom:0;
  display:block;
  padding:10px;
}
.slide-animate.ng-enter {
  top:-50px;
}
.slide-animate.ng-enter.ng-enter-active {
  top:0;
}
.slide-animate.ng-leave {
  top:0;
}
.slide-animate.ng-leave.ng-leave-active {
  top:50px;
}
</style>
</head>
<body ng-app='haApp'>
  <div class="container">
    <form action = "">
      <fieldset>
        <B>HaGUI</B>&nbsp;&nbsp;&nbsp;
        <button type="button" onclick="location.href='#/home'">Home</button>
        <button type="button" onclick="location.href='#/status'">Status</button>
        <button type="button" onclick="location.href='#/config'">Config</button>
        <button type="button" onclick="location.href='#/actions'">Actions</button>
      </fieldset>
    </form>
  </div>
  <div ng-view></div>
  <!-- GENERATE_VIEWS -->  
</body>

